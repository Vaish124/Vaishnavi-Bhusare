{% comment %}
  Figma Grid (from scratch)
  - Six product blocks with "pins" that open a custom modal
  - Variants rendered dynamically
  - Add-to-cart via AJAX fetch
  - Optional "auto add" product when conditions match
{% endcomment %}

<section id="gg-grid" class="gg-wrap" 
  data-trigger-color="{{ section.settings.trigger_color | escape }}"
  data-trigger-size="{{ section.settings.trigger_size | escape }}">
  <h2 class="gg-grid__title">{{ section.settings.grid_title }}</h2>

  <div class="gg-grid">
    {% for block in section.blocks %}
      {% assign p = block.settings.product %}
      {% if p %}
        <article class="gg-card" {{ block.shopify_attributes }}>
          {% if p.featured_media %}
            {{ p | media_image: class: 'gg-card__img', loading: 'lazy' }}
          {% endif %}
          <button class="gg-pin" aria-label="Show {{ p.title | escape }} details" data-product-json-id="prod-{{ block.id }}">ï¼‹</button>

          {%- comment -%} Embed product JSON for JS (stable & fast) {%- endcomment -%}
          <script type="application/json" id="prod-{{ block.id }}">{{ p | json }}</script>
        </article>
      {% else %}
        <article class="gg-card gg-card--placeholder" {{ block.shopify_attributes }}>
          <div class="gg-card__ph">Select a product</div>
        </article>
      {% endif %}
    {% endfor %}
  </div>

  <!-- ADD THIS MODAL HTML AFTER THE CLOSING </div> OF gg-grid -->
  <div id="gg-modal" class="gg-modal" style="display: none;">
    <div class="gg-modal__overlay">
      <div class="gg-modal__content">
        <button class="gg-modal__close" aria-label="Close">&times;</button>
        <div class="gg-modal__body">
          <div class="gg-modal__image">
            <img id="gg-modal-img" src="" alt="">
          </div>
          <div class="gg-modal__details">
            <h3 id="gg-modal-title"></h3>
            <p id="gg-modal-price"></p>
            <div id="gg-modal-description"></div>
            <div id="gg-modal-variants"></div>
            <button id="gg-modal-add-cart" class="gg-add-to-cart">Add to Cart</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  {%- if section.settings.auto_add_product != blank -%}
    <script type="application/json" id="gg-auto-product">{{ section.settings.auto_add_product | json }}</script>
  {%- endif -%}

  <!-- ADD THIS JAVASCRIPT BEFORE THE CLOSING </section> -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const pins = document.querySelectorAll('.gg-pin');
    const modal = document.getElementById('gg-modal');
    
    pins.forEach(pin => {
      pin.addEventListener('click', function() {
        const productJsonId = this.getAttribute('data-product-json-id');
        const productData = JSON.parse(document.getElementById(productJsonId).textContent);
        
        // Populate modal with product data
        document.getElementById('gg-modal-title').textContent = productData.title;
        document.getElementById('gg-modal-price').textContent = productData.price_min + ' CAD';
        document.getElementById('gg-modal-description').innerHTML = productData.description;
        
        if (productData.featured_media) {
          document.getElementById('gg-modal-img').src = productData.featured_media.preview_image.src;
        }
        
        // Show variants
        let variantsHtml = '';
        if (productData.variants && productData.variants.length > 1) {
          variantsHtml = '<div class="variants-section">';
          productData.variants.forEach(variant => {
            variantsHtml += `<button class="variant-btn" data-variant-id="${variant.id}">${variant.title} - ${variant.price} CAD</button>`;
          });
          variantsHtml += '</div>';
        }
        document.getElementById('gg-modal-variants').innerHTML = variantsHtml;
        
        // Show modal
        modal.style.display = 'block';
      });
    });
    
    // Close modal
    document.querySelector('.gg-modal__close').addEventListener('click', function() {
      modal.style.display = 'none';
    });
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });
  </script>
</section>

{% schema %}
{
  "name": "Gift Guide Grid",
  "settings": [
    { "type": "text", "id": "grid_title", "label": "Grid title", "default": "Tisso vison in the wild" },
    { "type": "text", "id": "trigger_color", "label": "Auto-add trigger color value", "default": "Black" },
    { "type": "text", "id": "trigger_size", "label": "Auto-add trigger size value", "default": "Medium" },
    { "type": "product", "id": "auto_add_product", "label": "Product to auto-add when the trigger variant is added", "info": "Optional. Example: Soft Winter Jacket" }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "limit": 6,
      "settings": [
        { "type": "product", "id": "product", "label": "Product" }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [{ "name": "Gift Guide Grid", "blocks": [{ "type": "product" },{ "type": "product" },{ "type": "product" },{ "type": "product" },{ "type": "product" },{ "type": "product" }] }]
}
{% endschema %}
